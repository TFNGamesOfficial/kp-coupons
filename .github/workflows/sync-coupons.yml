name: Sync Coupons to Supabase

on:
  push:
    paths:
      - "coupons.json"

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Transform coupons.json to Supabase schema
        run: |
          jq '[ .[] | {
            id: .id,
            title: .title,
            description: .description,
            brand: .brand,
            image_url: .imageURL,
            discountText: .discountText,
            daysLeft: .daysLeft,
            active: .activated
          } ]' coupons.json > transformed.json

      - name: Import coupons into Supabase Table
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          curl -X POST \
            "${SUPABASE_URL}/rest/v1/coupons?on_conflict=id" \
            -H "apikey: $SUPABASE_SERVICE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
            -H "Content-Type: application/json" \
            -H "Content-Profile: public" \
            -H "Prefer: resolution=merge-duplicates,return=minimal" \
            --data-binary @transformed.json
